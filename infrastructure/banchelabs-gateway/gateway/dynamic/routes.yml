# Dynamic Configuration for routes and services

http:
  # Routers
  routers:
    # Prefect API - shared infrastructure
    banchelabs-gateway:
      rule: "PathPrefix(`/prefect`)"
      service: banchelabs-gateway
      middlewares:
        - banchelabs-gateway-retry
        - banchelabs-gateway-auth
        - banchelabs-gateway-strip-prefix
      entryPoints:
        - websecure
      tls: {}

    # Umami Analytics (proxied to umami.fly.dev) - shared infrastructure
    traefik-umami:
      rule: "PathPrefix(`/umami`)"
      service: traefik-umami
      middlewares:
        - traefik-umami-retry
        - traefik-umami-strip-prefix
      entryPoints:
        - websecure
      tls: {}

    # Example: Future API service (on different machine)
    # captionacc-api:
    #   rule: "PathPrefix(`/captionacc/api`)"
    #   service: captionacc-api-service
    #   middlewares:
    #     - captionacc-api-auth
    #     - captionacc-api-strip-prefix
    #   entryPoints:
    #     - websecure
    #   tls: {}

  # Middlewares
  middlewares:
    # Retry middleware for cold starts (Prefect takes ~15-30s to start)
    banchelabs-gateway-retry:
      retry:
        attempts: 5
        initialInterval: 2s

    # JWT Authentication for Prefect
    banchelabs-gateway-auth:
      plugin:
        jwt:
          # JWT signing secret from environment variable (symmetric key)
          Keys:
            - "{{env `GATEWAY_JWT_SECRET`}}"

          # Require JWT to be present
          Required: true

          # Validate standard JWT claims
          PayloadFields:
            - exp
            - iat
            - jti
            - project
            - service

          # Forward JWT claims as headers to backend
          JwtHeaders:
            X-Gateway-Project: project
            X-Gateway-Service: service
            X-Gateway-JTI: jti

    # Strip /prefect prefix before forwarding
    banchelabs-gateway-strip-prefix:
      stripPrefix:
        prefixes:
          - "/prefect"

    # Retry middleware for Umami cold starts (similar to Prefect)
    traefik-umami-retry:
      retry:
        attempts: 5
        initialInterval: 2s

    # Strip /umami prefix before forwarding
    traefik-umami-strip-prefix:
      stripPrefix:
        prefixes:
          - "/umami"

    # Example: Future API middleware
    # captionacc-api-auth:
    #   plugin:
    #     jwt:
    #       Keys:
    #         - "{{env `TRAEFIK_JWT_SECRET`}}"
    #       Required: true
    #       PayloadFields:
    #         - exp
    #         - iat
    #         - jti
    #         - project
    #         - service
    #       JwtHeaders:
    #         X-Gateway-Project: project
    #         X-Gateway-Service: service
    #         X-Gateway-JTI: jti
    #
    # captionacc-api-strip-prefix:
    #   stripPrefix:
    #     prefixes:
    #       - "/captionacc/api"

  # Services (Backend targets)
  services:
    # Prefect on SAME machine (localhost)
    banchelabs-gateway:
      loadBalancer:
        servers:
          # Localhost - Prefect container on same machine
          - url: "http://localhost:4200"

        # Health check
        healthCheck:
          path: /api/health
          interval: 30s
          timeout: 5s
          scheme: http

    # Umami Analytics on separate Fly.io machine
    traefik-umami:
      loadBalancer:
        servers:
          # External Fly.io app - uses public DNS
          - url: "https://umami.fly.dev"

        # Health check (umami root returns 200)
        healthCheck:
          path: /
          interval: 30s
          timeout: 10s
          scheme: https

    # Example: Future API service (on different Fly.io machine)
    # captionacc-api-service:
    #   loadBalancer:
    #     servers:
    #       # Fly.io internal DNS (6PN private network)
    #       - url: "http://captionacc-api.internal:8000"
    #     healthCheck:
    #       path: /health
    #       interval: 30s
    #       timeout: 5s
    #       scheme: http
