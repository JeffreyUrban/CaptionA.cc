# CaptionA.cc Project Dynamic Configuration
# Routes and services specific to the CaptionA.cc project

http:
  # Routers
  routers:
    # CaptionA.cc Prefect API
    captionacc-prefect:
      rule: "PathPrefix(`/captionacc/prefect`)"
      service: captionacc-prefect-service
      middlewares:
        - captionacc-prefect-auth
        - captionacc-prefect-strip-prefix
      entryPoints:
        - websecure
      tls: {}

  # Middlewares
  middlewares:
    # JWT Authentication for Prefect
    captionacc-prefect-auth:
      plugin:
        jwt:
          # JWT signing secret from environment variable (symmetric key)
          Keys:
            - "{{env `GATEWAY_JWT_SECRET`}}"

          # Require JWT to be present
          Required: true

          # Validate standard JWT claims
          PayloadFields:
            - exp
            - iat
            - jti
            - project
            - service

          # Forward JWT claims as headers to backend
          JwtHeaders:
            X-Gateway-Project: project
            X-Gateway-Service: service
            X-Gateway-JTI: jti

    # Strip /captionacc/prefect prefix before forwarding
    captionacc-prefect-strip-prefix:
      stripPrefix:
        prefixes:
          - "/captionacc/prefect"

  # Services (Backend targets)
  services:
    captionacc-prefect-service:
      loadBalancer:
        servers:
          # Fly.io internal DNS (6PN private network)
          - url: "http://prefect-service.internal:4200"

        # Health check
        healthCheck:
          path: /api/health
          interval: 30s
          timeout: 5s
          scheme: http
