# Fly.io configuration for CaptionA.cc Orchestrator Service
# See https://fly.io/docs/reference/configuration/ for details

app = "captionacc-orchestrator"
primary_region = "ewr"  # US East (same region as web app)

[build]
  dockerfile = "Dockerfile"

[env]
  # Environment identifier
  ENVIRONMENT = "production"

  # Schema is set in secrets, but can be overridden here for staging
  # SUPABASE_SCHEMA = "captionacc_staging"  # Uncomment for staging deployments

  # Secrets are set via: flyctl secrets set
  # Required secrets:
  #   SUPABASE_URL
  #   SUPABASE_SCHEMA (set to captionacc_production or captionacc_staging)
  #   SUPABASE_SERVICE_ROLE_KEY
  #   WASABI_ACCESS_KEY_READWRITE
  #   WASABI_SECRET_KEY_READWRITE
  #   WASABI_BUCKET
  #   WASABI_REGION
  #
  # Optional secrets (for future Prefect server deployment):
  #   PREFECT_API_URL - URL of separate Prefect server (if deployed)
  #   PREFECT_API_KEY - API key for Prefect server
  # Note: Currently using ephemeral mode (no separate server needed)

  # Prefect worker configuration
  WORKER_CONCURRENCY = "2"
  LOG_LEVEL = "INFO"

[http_service]
  internal_port = 8000
  force_https = true
  auto_stop_machines = false  # Keep running for Prefect worker
  auto_start_machines = true
  min_machines_running = 1
  processes = ["app"]

  # Health checks (verifies both API and worker health)
  [[http_service.checks]]
    interval = "30s"              # Check every 30 seconds
    timeout = "5s"                # Fail if no response in 5s
    grace_period = "90s"          # Allow 90s startup time (Prefect connection)
    method = "GET"
    path = "/health"

    # Restart policy: restart after 3 consecutive failures (90s of downtime)
    # This prevents restart loops from transient issues

[[vm]]
  cpu_kind = "shared"
  cpus = 2
  memory_mb = 2048

[deploy]
  # Optional: Run migrations or setup before starting
  # release_command = "python setup.py"

# Command to start both health API and Prefect worker
# Override via fly.toml if needed, or set CMD in Dockerfile
# Default: python start_all.py
