name: Hourly Health Check & Keep-Alive

# This workflow runs hourly to:
# 1. Keep Supabase free tier active (prevent hibernation)
# 2. Wake API servers to allow Prefect workers to process scheduled jobs
# 3. Check health of web and API services
# 4. Alert via email on failures

on:
  schedule:
    # Run hourly at minute 47 (offset to avoid on-the-hour congestion)
    - cron: '47 * * * *'

  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  health-check:
    name: Health Check & Keep-Alive
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      # =========================================================================
      # SUPABASE KEEP-ALIVE
      # =========================================================================

      - name: Supabase Keep-Alive (Prod)
        env:
          SUPABASE_URL: ${{ vars.SUPABASE_URL_PROD }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_PROD }}
        run: |
          echo "üì° Pinging Supabase prod to prevent hibernation..."

          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "‚ö†Ô∏è  Supabase prod credentials not configured, skipping"
            exit 0
          fi

          response=$(curl -s -w "\n%{http_code}" \
            "${SUPABASE_URL}/rest/v1/" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}")

          http_code=$(echo "$response" | tail -n1)

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Supabase prod is active"
          else
            echo "‚ùå Supabase prod keep-alive failed with HTTP $http_code"
            # Don't fail workflow, just warn
          fi

      - name: Supabase Keep-Alive (Dev)
        env:
          SUPABASE_URL: ${{ vars.SUPABASE_URL_DEV }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_DEV }}
        run: |
          echo "üì° Pinging Supabase dev to prevent hibernation..."

          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "‚ö†Ô∏è  Supabase dev credentials not configured, skipping"
            exit 0
          fi

          response=$(curl -s -w "\n%{http_code}" \
            "${SUPABASE_URL}/rest/v1/" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}")

          http_code=$(echo "$response" | tail -n1)

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Supabase dev is active"
          else
            echo "‚ùå Supabase dev keep-alive failed with HTTP $http_code"
            # Don't fail workflow, just warn
          fi

      # =========================================================================
      # API WAKE-UP (triggers Prefect workers to process scheduled jobs)
      # =========================================================================

      - name: Wake API Server (Prod)
        run: |
          echo "üöÄ Waking captionacc-api-prod to enable Prefect worker..."

          # Health check endpoint auto-starts the Fly machine
          response=$(curl -s -w "\n%{http_code}" --max-time 120 \
            https://captionacc-api-prod.fly.dev/health)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ API prod is healthy - Prefect worker active"
            echo "$body" | jq '.' 2>/dev/null || echo "$body"
          else
            echo "‚ö†Ô∏è  API prod health check returned HTTP $http_code"
            echo "$body"
            # Don't fail - machine may still be starting
          fi

      - name: Wake API Server (Dev)
        run: |
          echo "üöÄ Waking captionacc-api-dev to enable Prefect worker..."

          # Health check endpoint auto-starts the Fly machine
          response=$(curl -s -w "\n%{http_code}" --max-time 120 \
            https://captionacc-api-dev.fly.dev/health)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ API dev is healthy - Prefect worker active"
            echo "$body" | jq '.' 2>/dev/null || echo "$body"
          else
            echo "‚ö†Ô∏è  API dev health check returned HTTP $http_code"
            echo "$body"
            # Don't fail - machine may still be starting
          fi

      # =========================================================================
      # WEB APP HEALTH CHECKS
      # =========================================================================

      - name: Check Web App Health (Prod)
        run: |
          echo "üè• Checking captionacc-web-prod health..."

          response=$(curl -s -w "\n%{http_code}" --max-time 60 \
            https://captionacc-web-prod.fly.dev/health)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Web prod is healthy"
          else
            echo "‚ö†Ô∏è  Web prod returned HTTP $http_code"
            echo "$body"
          fi

      - name: Check Web App Health (Dev)
        run: |
          echo "üè• Checking captionacc-web-dev health..."

          response=$(curl -s -w "\n%{http_code}" --max-time 60 \
            https://captionacc-web-dev.fly.dev/health)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Web dev is healthy"
          else
            echo "‚ö†Ô∏è  Web dev returned HTTP $http_code"
            echo "$body"
          fi

      # =========================================================================
      # SUMMARY
      # =========================================================================

      - name: Summary
        if: always()
        run: |
          echo "==========================================="
          echo "Health Check & Keep-Alive Complete"
          echo "==========================================="
          echo ""
          echo "Services pinged:"
          echo "  - Supabase prod & dev (keep-alive)"
          echo "  - API prod & dev (wake Prefect workers)"
          echo "  - Web prod & dev (health check)"
          echo ""
          echo "Next run: In ~1 hour"

      # =========================================================================
      # MONITORING
      # =========================================================================

      - name: Ping Better Stack Heartbeat
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="success"
            echo "‚úÖ Pinging Better Stack: Workflow succeeded"
          else
            STATUS="fail"
            echo "‚ùå Pinging Better Stack: Workflow failed"
          fi

          if [ -n "${{ secrets.BETTERSTACK_HEARTBEAT_URL }}" ]; then
            curl -fsS --retry 3 "${{ secrets.BETTERSTACK_HEARTBEAT_URL }}?status=${STATUS}" || echo "‚ö†Ô∏è  Failed to ping Better Stack (non-fatal)"
          else
            echo "‚ÑπÔ∏è  BETTERSTACK_HEARTBEAT_URL not configured, skipping"
          fi
