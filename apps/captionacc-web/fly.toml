# fly.toml app configuration file for captionacc-web
#
# See https://fly.io/docs/reference/configuration/ for information about how to use this file.
#

app = 'captionacc-web'
primary_region = 'ewr'

[build]

[env]
  NODE_ENV = "production"
  ENVIRONMENT = "production"

  # Public Vite environment variables (embedded in client bundle at build time)
  # These are REQUIRED for the app to work - they're not secrets
  # The anon key is designed to be public (RLS policies protect data)
  VITE_SUPABASE_URL = "https://stbnsczvywpwjzbpfehp.supabase.co"  # pragma: allowlist secret
  VITE_SUPABASE_SCHEMA = "captionacc_production"
  VITE_SUPABASE_ANON_KEY = "sb_publishable_nJJjrTJfnlqPtEpWWnuyjw_tzqgZ8uf"  # pragma: allowlist secret

  # Umami analytics (public, embedded in client bundle)
  # Routed through Traefik gateway
  VITE_UMAMI_SRC = "https://banchelabs-gateway.fly.dev/umami/script.js"
  VITE_UMAMI_WEBSITE_ID = "1df05312-93bf-4de5-9a0d-3dae1ee1620e"  # pragma: allowlist secret

  # Server-side secrets (keep as secrets, not here):
  # - VITE_SUPABASE_SERVICE_ROLE_KEY (server-side only, never exposed to client)
  # - WASABI_ACCESS_KEY_READONLY
  # - WASABI_SECRET_KEY_READONLY
  # - WASABI_BUCKET
  # - WASABI_REGION

[http_service]
  internal_port = 3000
  force_https = true
  auto_stop_machines = 'stop'
  auto_start_machines = true
  min_machines_running = 0
  processes = ['app']

  # Health checks (internal - don't prevent auto-sleep)
  [[http_service.checks]]
    interval = "30s"              # Check every 30 seconds
    timeout = "5s"                # Fail if no response in 5s
    grace_period = "60s"          # Allow 60s startup time before checking
    method = "GET"
    path = "/health"

    # Restart policy: restart after 3 consecutive failures (90s of downtime)
    # This prevents restart loops from transient issues

[[vm]]
  size = 'shared-cpu-1x'
